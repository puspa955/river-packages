import{QueryClient as e,QueryClientProvider as r}from"@tanstack/react-query";import t,{useState as n,useMemo as a,useCallback as l,useEffect as s}from"react";import{ChevronDown as i,Search as o,X as c,SlidersHorizontal as h,Loader2 as d}from"lucide-react";import{jsxs as u,jsx as m}from"react/jsx-runtime";const y=({label:e,isNested:r=!1,children:t,defaultExpanded:a=!0})=>{const[l,s]=n(a);return u("div",{className:r?"":" mb-3 border-b border-gray-200",children:[u("button",{onClick:()=>s(!l),className:"w-full flex justify-between group",children:[m(r?"h4":"h3",{className:r?"text-xs font-medium text-gray-700 pb-2":"text-[13px] font-semibold text-gray-800 tracking-wide uppercase pb-2",children:e}),m(i,{className:"w-5 h-5 text-gray-600 hover:text-primary-600 transition-transform "+(l?"rotate-180":"")})]}),l&&m("div",{className:"mb-3 space-y-0.5",children:t})]})},f=({checked:e,onChange:r,label:t})=>u("label",{className:"flex items-start gap-3 cursor-pointer group w-fit",children:[m("input",{type:"checkbox",checked:e,onChange:r,className:"mt-0.5 w-4 h-4 rounded-sm border-gray-300 accent-primary-600 focus:ring-primary-500 cursor-pointer transition-colors group-hover:border-primary-600"}),m("span",{className:"text-sm text-gray-900 font-light group-hover:text-primary-600 transition-colors",children:t})]}),p=({config:e={},value:r=[],onChange:t,isNested:a=!1})=>{const[s,i]=n(!1),o=l(e=>{const n=r.includes(e)?r.filter(r=>r!==e):[...r,e];t(n.length?n:void 0)},[r,t]);if(!e.options||0===e.options.length)return null;const c=s?e.options:e.options.slice(0,5);return u(y,{label:e.label,isNested:a,children:[c.map(e=>m(f,{label:e,checked:(null==r?void 0:r.includes(e))||!1,onChange:()=>o(e)},e)),e.options.length>5&&m("button",{onClick:()=>i(!s),className:"mt-2 text-primary-600 hover:text-primary-500 text-xs inline-flex items-center gap-1 underline",children:s?"See less":"See all"})]})},g=({config:e,value:r=[],onChange:t,isNested:n=!1})=>{var a;const s=l(e=>{const n=r.includes(e)?r.filter(r=>r!==e):[...r,e];t(n.length?n:void 0)},[r,t]);return null!==(a=e.ranges)&&void 0!==a&&a.length?m(y,{label:e.label,isNested:n,children:e.ranges.map(e=>m(f,{label:e.label,checked:(null==r?void 0:r.includes(e.label))||!1,onChange:()=>s(e.label)},e.label))}):null},b=({config:e,value:r=!1,onChange:t})=>m("div",{children:m(f,{checked:!!r,onChange:e=>t(!!e.target.checked||void 0),label:e.label})}),x=({config:e,filters:r,onFilterChange:t,defaultExpanded:n=!0})=>e.children&&0!==e.children.length?m(y,{label:e.label,defaultExpanded:n,children:e.children.map(n=>{const a=e.childrenSchema[n];return a?"checkbox-group"===a.type?m(p,{config:a,value:r[n],onChange:e=>t(n,e),isNested:!0},n):"range"===a.type?m(g,{config:a,value:r[n],onChange:e=>t(n,e),isNested:!0},n):null:null})}):null,v=({schema:e,filters:r,onRemove:t})=>{const n=a(()=>{const t=[],n=e=>{Object.entries(e).forEach(([e,a])=>{if("group"===a.type&&a.childrenSchema)return void n(a.childrenSchema);const l=r[e];l&&("search"===a.type?t.push({key:e,label:l,type:"search"}):"checkbox"===a.type&&!0===l?t.push({key:e,label:a.label,type:"checkbox"}):Array.isArray(l)&&l.length>0&&l.forEach(r=>t.push({key:e,label:r,type:"array",value:r})))})};return n(e),t},[e,r]);return n.length?m("div",{className:"flex flex-wrap gap-2 mt-3",children:n.map(e=>u("span",{className:"inline-flex items-center gap-1.5 px-2 py-1 bg-primary-100/80 text-gray-700 text-sm border",children:[m("span",{children:e.label}),m("button",{onClick:()=>t(e),className:"hover:text-primary-600 rounded-full p-0.5 transition-colors",children:m(c,{className:"w-3.5 h-3.5"})})]},`${e.key}-${e.value||""}`))}):null},N=({schema:e,filters:r,onFilterChange:t})=>{const n=Object.entries(e).find(([e,r])=>"search"===r.type);if(!n)return null;const[a,l]=n,s=r[a]||"";return u("div",{className:"mb-6",children:[u("div",{className:"relative",children:[m(o,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),m("input",{type:"text",placeholder:l.placeholder,value:s,onChange:e=>t(a,e.target.value),className:"w-full pl-10 pr-10 py-3 border border-gray-400/70 focus:ring-1 focus:ring-primary-500 focus:border-transparent outline-none text-sm"}),s&&m("button",{onClick:()=>t(a,""),className:"absolute right-3 top-1/2 -translate-y-1/2",children:m(c,{className:"w-4 h-4 text-gray-400 hover:text-gray-600"})})]}),m(v,{schema:e,filters:r,onRemove:e=>{if("search"===e.type)t(e.key,"");else if("array"===e.type){const n=(r[e.key]||[]).filter(r=>r!==e.value);t(e.key,n.length?n:void 0)}else"checkbox"===e.type&&t(e.key,void 0)}})]})},w=({schema:e,filters:r,onFilterChange:n})=>{const[a,l]=t.useState(!0),s=Object.entries(e).filter(([,e])=>"checkbox"===e.type);return u("div",{className:"w-72 bg-white border-r border-gray-200 h-screen overflow-y-auto p-6 sticky top-0 custom-scroll",children:[u("div",{className:"flex items-center gap-2 mb-6",children:[m(h,{className:"w-5 h-5 text-primary-600"}),m("h2",{className:"text-lg font-semibold text-gray-900 tracking-tight",children:"Filters"})]}),s.length>0&&u("div",{className:"pb-3 mb-3 border-b border-gray-200",children:[u("button",{onClick:()=>l(!a),className:"w-full flex items-center justify-between group",children:[m("h3",{className:"text-[13px] font-semibold text-gray-800 tracking-wide uppercase",children:"General"}),m(i,{className:"w-5 h-5 text-gray-600 hover:text-primary-600 transition-transform "+(a?"rotate-180":"")})]}),a&&m("div",{className:"space-y-0.5 mt-2",children:s.map(([e,t])=>m(b,{config:t,value:r[e],onChange:r=>n(e,r)},e))})]}),Object.entries(e).map(([e,t])=>((e,t)=>"search"===t.type?null:"group"===t.type?m(x,{config:t,filters:r,onFilterChange:n},e):"checkbox-group"===t.type?m(p,{config:t,value:r[e],onChange:r=>n(e,r)},e):"range"===t.type?m(g,{config:t,value:r[e],onChange:r=>n(e,r)},e):null)(e,t))]})},k=(e,r)=>e&&r?r.split(".").reduce((e,r)=>null!=e?e[r]:null,e):null,A=e=>{try{const r=(e=>Object.fromEntries(Object.entries(e).filter(([,e])=>null!=e&&""!==e&&!(Array.isArray(e)&&0===e.length)&&!1!==e)))(e);return Object.keys(r).length?btoa(encodeURIComponent(JSON.stringify(r))):""}catch{return""}},C=e=>{const r={};let t=null;const n=e=>{e&&"object"==typeof e&&Object.entries(e).forEach(([e,a])=>{if(!a)return;const l=String(a.type).toLowerCase();"group"===l&&a.childrenSchema?n(a.childrenSchema):"search"===l?t={key:e,config:a}:r[e]=a})};return n(e),{flat:r,search:t}},S={"checkbox-group":(e,r,t)=>{t.transform&&null!=e&&(e=t.transform(e));const n=Array.isArray(e)?e:[e],a=Array.isArray(r)?r:[r],l=n.map(e=>e?String(e).toLowerCase():e),s=a.map(e=>e?String(e).toLowerCase():e);if(s.includes("other")&&t.options){const e=t.options.map(e=>e.toLowerCase());if(l.some(r=>r&&!e.includes(r)))return!0}return s.some(e=>l.includes(e))},range:(e,r,t)=>{const n=Number(e);return!isNaN(n)&&r.some(e=>{var r;const a=null===(r=t.ranges)||void 0===r?void 0:r.find(r=>r.label===e);return!!a&&(n>=a.min&&n<=a.max)})},checkbox:(e,r)=>!r||!!e},j=(e,r)=>{r&&Array.isArray(r)||(console.warn("updateSchemaWithDynamicOptions: data must be an array, received:",typeof r),r=[]);const t=((e,r)=>{if(!e||!Array.isArray(e))return console.warn("extractDynamicOptions: data must be an array, received:",typeof e),{};if(!e.length)return{};const{flat:t}=C(r),n={};return t&&"object"==typeof t?(Object.entries(t).forEach(([r,t])=>{var a;if(!t)return;if(null!==(a=t.options)&&void 0!==a&&a.length)return;if(!["checkbox-group","checkbox"].includes(t.type))return;const l=new Set;Array.isArray(e)&&e.forEach(e=>{let r=k(e,t.field);t.transform&&null!=r&&(r=t.transform(r)),t.isArray&&Array.isArray(r)?r.forEach(e=>null!=e&&l.add(String(e))):null!=r&&l.add(String(r))}),n[r]=Array.from(l).sort()}),n):{}})(r,e),n=e=>e&&"object"==typeof e?Object.fromEntries(Object.entries(e).map(([e,r])=>{var a;if(!r)return[e,r];const l={...r};return"group"===r.type&&r.childrenSchema?l.childrenSchema=n(r.childrenSchema):null!==(a=t[e])&&void 0!==a&&a.length&&(l.options=t[e]),[e,l]})):{};return n(e)},O=({schema:e,data:r,renderContent:t,enableUrlSync:i=!0,className:o=""})=>{const[c,h]=n({}),[y,f]=n([]),[p,g]=n(!0),[b,x]=n(null);s(()=>{(async()=>{g(!0),x(null);try{let e;if(Array.isArray(r))e=r;else if("string"==typeof r){const t=await fetch(r);if(!t.ok)throw new Error(`Failed to fetch: ${t.status} ${t.statusText}`);e=await t.json()}else"function"==typeof r?e=await r():(console.warn("DatasetFilter: data must be array, URL string, or async function"),e=[]);const t=Array.isArray(e)?e:[];f(t)}catch(e){console.error("DatasetFilter error:",e),x(e),f([])}finally{g(!1)}})()},[r]);const v=l((e,r)=>{h(t=>{const n={...t};return null==r||""===r||Array.isArray(r)&&0===r.length||!1===r?delete n[e]:n[e]=r,n})},[]);s(()=>{if(i)try{const e=new URLSearchParams(window.location.search).get("f");if(e){const r=(e=>{try{return JSON.parse(decodeURIComponent(atob(e)))}catch{return{}}})(e);Object.keys(r).length>0&&h(r)}}catch(e){console.error("Failed to decode filters from URL:",e)}},[i]),s(()=>{if(i)try{const e=A(c);if(!e)return void window.history.replaceState({},"",window.location.pathname);const r=new URLSearchParams;r.set("f",e),window.history.replaceState({},"",`?${r.toString()}`)}catch(e){console.error("Failed to encode filters to URL:",e)}},[c,i]);const O=a(()=>{const r=Array.isArray(y)?y:[];return j(e,r)},[e,y]),E=a(()=>((e,r,t)=>{if(!Array.isArray(e))return[];if(!e.length)return[];if(!r||!Object.keys(r).length)return e;const{flat:n,search:a}=C(t);return e.filter(e=>{var t;if(a&&null!==(t=r[a.key])&&void 0!==t&&t.trim()){const t=r[a.key].toLowerCase();if(!(Array.isArray(a.config.fields)?a.config.fields:[a.config.field]).some(r=>{const n=k(e,r);return Array.isArray(n)?n.some(e=>String(e||"").toLowerCase().includes(t)):String(n||"").toLowerCase().includes(t)}))return!1}return Object.entries(r).every(([r,t])=>{if(a&&r===a.key)return!0;if(!t||Array.isArray(t)&&!t.length)return!0;const l=n[r];if(!l)return!0;let s=k(e,l.field);const i=S[l.type];return!i||i(s,t,l)})})})(Array.isArray(y)?y:[],c,O),[y,c,O]);return p?m("div",{className:"flex items-center justify-center min-h-screen",children:u("div",{className:"text-center",children:[m(d,{className:"w-8 h-8 animate-spin text-blue-600 mx-auto mb-2"}),m("p",{className:"text-gray-600",children:"Loading data..."})]})}):b?m("div",{className:"flex items-center justify-center min-h-screen",children:u("div",{className:"text-center",children:[u("div",{className:"text-red-600 mb-4",children:[m("p",{className:"font-semibold text-lg mb-2",children:"Error loading data"}),m("p",{className:"text-sm",children:b.message})]}),m("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors",children:"Retry"})]})}):u("div",{className:`flex min-h-screen bg-gray-50 ${o}`,children:[m(w,{schema:O,filters:c,onFilterChange:v}),m("div",{className:"flex-1 p-8",children:u("div",{className:"max-w-5xl mx-auto",children:[m(N,{schema:O,filters:c,onFilterChange:v,onRemoveFilter:v}),t&&t({filteredData:E,totalData:y,filters:c})]})})]})},E=new e,F=e=>m(r,{client:E,children:m(O,{...e})});export{F as DatasetFilter};
//# sourceMappingURL=index.esm.js.map
