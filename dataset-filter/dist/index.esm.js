import{useQuery as e,QueryClient as r,QueryClientProvider as t}from"@tanstack/react-query";import n,{useState as a,useMemo as l,useCallback as s,useEffect as c}from"react";import{ChevronDown as i,Search as o,X as h,SlidersHorizontal as d,Loader2 as u}from"lucide-react";import{jsxs as m,jsx as p}from"react/jsx-runtime";const g=({label:e,isNested:r=!1,children:t,defaultExpanded:n=!0})=>{const[l,s]=a(n);return m("div",{className:r?"":" mb-3 border-b border-gray-200",children:[m("button",{onClick:()=>s(!l),className:"w-full flex justify-between group",children:[p(r?"h4":"h3",{className:r?"text-xs font-medium text-gray-700 pb-2":"text-[13px] font-semibold text-gray-800 tracking-wide uppercase pb-2",children:e}),p(i,{className:"w-5 h-5 text-gray-600 hover:text-primary-600 transition-transform "+(l?"rotate-180":"")})]}),l&&p("div",{className:"mb-3 space-y-0.5",children:t})]})},y=({checked:e,onChange:r,label:t})=>m("label",{className:"flex items-start gap-3 cursor-pointer group w-fit",children:[p("input",{type:"checkbox",checked:e,onChange:r,className:"mt-0.5 w-4 h-4 rounded-sm border-gray-300 accent-primary-600 focus:ring-primary-500 cursor-pointer transition-colors group-hover:border-primary-600"}),p("span",{className:"text-sm text-gray-900 font-light group-hover:text-primary-600 transition-colors",children:t})]}),f=({config:e={},value:r=[],onChange:t,isNested:n=!1})=>{const[l,c]=a(!1),i=s(e=>{const n=r.includes(e)?r.filter(r=>r!==e):[...r,e];t(n.length?n:void 0)},[r,t]);if(!e.options||0===e.options.length)return null;const o=l?e.options:e.options.slice(0,5);return m(g,{label:e.label,isNested:n,children:[o.map(e=>p(y,{label:e,checked:(null==r?void 0:r.includes(e))||!1,onChange:()=>i(e)},e)),e.options.length>5&&p("button",{onClick:()=>c(!l),className:"mt-2 text-primary-600 hover:text-primary-500 text-xs inline-flex items-center gap-1 underline",children:l?"See less":"See all"})]})},b=({config:e,value:r=[],onChange:t,isNested:n=!1})=>{var a;const l=s(e=>{const n=r.includes(e)?r.filter(r=>r!==e):[...r,e];t(n.length?n:void 0)},[r,t]);return null!==(a=e.ranges)&&void 0!==a&&a.length?p(g,{label:e.label,isNested:n,children:e.ranges.map(e=>p(y,{label:e.label,checked:(null==r?void 0:r.includes(e.label))||!1,onChange:()=>l(e.label)},e.label))}):null},x=({config:e,value:r=!1,onChange:t})=>p("div",{children:p(y,{checked:!!r,onChange:e=>t(!!e.target.checked||void 0),label:e.label})}),v=({config:e,filters:r,onFilterChange:t,defaultExpanded:n=!0})=>e.children&&0!==e.children.length?p(g,{label:e.label,defaultExpanded:n,children:e.children.map(n=>{const a=e.childrenSchema[n];return a?"checkbox-group"===a.type?p(f,{config:a,value:r[n],onChange:e=>t(n,e),isNested:!0},n):"range"===a.type?p(b,{config:a,value:r[n],onChange:e=>t(n,e),isNested:!0},n):null:null})}):null,N=({schema:e,filters:r,onRemove:t})=>{const n=l(()=>{const t=[],n=e=>{Object.entries(e).forEach(([e,a])=>{if("group"===a.type&&a.childrenSchema)return void n(a.childrenSchema);const l=r[e];l&&("search"===a.type?t.push({key:e,label:l,type:"search"}):"checkbox"===a.type&&!0===l?t.push({key:e,label:a.label,type:"checkbox"}):Array.isArray(l)&&l.length>0&&l.forEach(r=>t.push({key:e,label:r,type:"array",value:r})))})};return n(e),t},[e,r]);return n.length?p("div",{className:"flex flex-wrap gap-2 mt-3",children:n.map(e=>m("span",{className:"inline-flex items-center gap-1.5 px-2 py-1 bg-primary-100/80 text-gray-700 text-sm border",children:[p("span",{children:e.label}),p("button",{onClick:()=>t(e),className:"hover:text-primary-600 rounded-full p-0.5 transition-colors",children:p(h,{className:"w-3.5 h-3.5"})})]},`${e.key}-${e.value||""}`))}):null},w=({schema:e,filters:r,onFilterChange:t})=>{const n=Object.entries(e).find(([e,r])=>"search"===r.type);if(!n)return null;const[a,l]=n,s=r[a]||"";return m("div",{className:"mb-6",children:[m("div",{className:"relative",children:[p(o,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),p("input",{type:"text",placeholder:l.placeholder,value:s,onChange:e=>t(a,e.target.value),className:"w-full pl-10 pr-10 py-3 border border-gray-400/70 focus:ring-1 focus:ring-primary-500 focus:border-transparent outline-none text-sm"}),s&&p("button",{onClick:()=>t(a,""),className:"absolute right-3 top-1/2 -translate-y-1/2",children:p(h,{className:"w-4 h-4 text-gray-400 hover:text-gray-600"})})]}),p(N,{schema:e,filters:r,onRemove:e=>{if("search"===e.type)t(e.key,"");else if("array"===e.type){const n=(r[e.key]||[]).filter(r=>r!==e.value);t(e.key,n.length?n:void 0)}else"checkbox"===e.type&&t(e.key,void 0)}})]})},k=({schema:e,filters:r,onFilterChange:t})=>{const[a,l]=n.useState(!0),s=Object.entries(e).filter(([,e])=>"checkbox"===e.type);return m("div",{className:"w-72 bg-white border-r border-gray-200 h-screen overflow-y-auto p-6 sticky top-0 custom-scroll",children:[m("div",{className:"flex items-center gap-2 mb-6",children:[p(d,{className:"w-5 h-5 text-primary-600"}),p("h2",{className:"text-lg font-semibold text-gray-900 tracking-tight",children:"Filters"})]}),s.length>0&&m("div",{className:"pb-3 mb-3 border-b border-gray-200",children:[m("button",{onClick:()=>l(!a),className:"w-full flex items-center justify-between group",children:[p("h3",{className:"text-[13px] font-semibold text-gray-800 tracking-wide uppercase",children:"General"}),p(i,{className:"w-5 h-5 text-gray-600 hover:text-primary-600 transition-transform "+(a?"rotate-180":"")})]}),a&&p("div",{className:"space-y-0.5 mt-2",children:s.map(([e,n])=>p(x,{config:n,value:r[e],onChange:r=>t(e,r)},e))})]}),Object.entries(e).map(([e,n])=>((e,n)=>"search"===n.type?null:"group"===n.type?p(v,{config:n,filters:r,onFilterChange:t},e):"checkbox-group"===n.type?p(f,{config:n,value:r[e],onChange:r=>t(e,r)},e):"range"===n.type?p(b,{config:n,value:r[e],onChange:r=>t(e,r)},e):null)(e,n))]})},C=(e,r)=>r&&e?r.split(".").reduce((e,r)=>null==e?null:e[r],e):null,S=(e,r)=>{const t=((e,r)=>{const t={},n={};var a;return a=r,Object.entries(a).forEach(([e,r])=>{"group"===r.type&&r.childrenSchema?Object.entries(r.childrenSchema).forEach(([e,r])=>{n[e]=r}):n[e]=r}),Object.entries(n).forEach(([r,n])=>{if(n.options&&n.options.length>0)return;if(!["checkbox-group","select","checkbox"].includes(n.type))return;const a=new Set;e.forEach(e=>{let r=C(e,n.field);n.transform&&null!=r&&(r=n.transform(r)),n.isArray&&Array.isArray(r)?r.forEach(e=>null!==e&&a.add(String(e))):null!=r&&a.add(String(r))}),t[r]=Array.from(a).sort()}),t})(r,e),n={};return Object.entries(e).forEach(([e,r])=>{n[e]={...r},"group"===r.type&&r.childrenSchema?(n[e].childrenSchema={},Object.entries(r.childrenSchema).forEach(([r,a])=>{n[e].childrenSchema[r]={...a},t[r]&&t[r].length>0&&(n[e].childrenSchema[r].options=t[r])})):t[e]&&t[e].length>0&&(n[e].options=t[e])}),n},A=e=>{try{const r=(e=>{const r={};return Object.entries(e).forEach(([e,t])=>{null==t||""===t||Array.isArray(t)&&0===t.length||!1===t||(r[e]=t)}),r})(e);if(0===Object.keys(r).length)return"";const t=JSON.stringify(r);return btoa(encodeURIComponent(t))}catch(e){return""}},j=({schema:r,data:t=[],queryKey:n,queryFn:i,dataTransform:o=e=>e,renderContent:h,enableUrlSync:d=!0,queryOptions:g={},className:y=""})=>{const[f,b]=a({}),{data:x,isLoading:v,error:N}=e({queryKey:n||["dataset"],queryFn:i||(()=>Promise.resolve({data:t})),enabled:!!i,...g}),j=i?o(x)||[]:t,O=l(()=>S(r,j),[r,j]),E=l(()=>((e,r,t)=>{const n={};let a=null;var l;return l=t,Object.entries(l).forEach(([e,r])=>{"group"===r.type&&r.childrenSchema?Object.entries(r.childrenSchema).forEach(([e,r])=>{n[e]=r}):"search"===r.type?a={key:e,...r}:n[e]=r}),e.filter(e=>{if(a&&r[a.key]){const t=r[a.key];if(!(Array.isArray(a.fields)?a.fields:[a.field]).some(r=>{const n=C(e,r);return Array.isArray(n)?n.some(e=>String(e||"").toLowerCase().includes(t.toLowerCase())):String(n||"").toLowerCase().includes(t.toLowerCase())}))return!1}return Object.entries(r).every(([r,t])=>{if(a&&r===a.key)return!0;if(!t||Array.isArray(t)&&0===t.length)return!0;const l=n[r];if(!l)return!0;let s=C(e,l.field);switch(l.type){case"search":return(Array.isArray(l.fields)?l.fields:[l.field]).some(r=>{const n=C(e,r);return String(n||"").toLowerCase().includes(t.toLowerCase())});case"checkbox-group":{l.transform&&null!=s&&(s=l.transform(s));const e=Array.isArray(s)?s:[s],r=Array.isArray(t)?t:[t],n=e.map(e=>e?String(e).toLowerCase():e),a=r.map(e=>e?String(e).toLowerCase():e);if(a.includes("other")&&l.options){const e=l.options.map(e=>e.toLowerCase());if(n.some(r=>r&&!e.includes(r)))return!0}return a.some(e=>n.includes(e))}case"range":{const e=Number(s);return!isNaN(e)&&null!=s&&t.some(r=>{const t=l.ranges.find(e=>e.label===r);return!!t&&e>=t.min&&e<=t.max})}case"checkbox":return!t||!!s;case"select":{if(!s)return!1;const e=String(s).toLowerCase(),r=String(t).toLowerCase();return"other"===r&&l.options?!l.options.map(e=>e.toLowerCase()).includes(e):e===r}default:return!0}})})})(j,f,O),[j,f,O]),L=s((e,r)=>{b(t=>{const n={...t};return null==r||""===r||Array.isArray(r)&&0===r.length||!1===r?delete n[e]:n[e]=r,n})},[]);return c(()=>{if(!d)return;const e=new URLSearchParams(window.location.search).get("f");e&&b((e=>{try{const r=decodeURIComponent(atob(e));return JSON.parse(r)}catch(e){return{}}})(e))},[d]),c(()=>{if(!d)return;const e=A(f);if(!e)return void window.history.replaceState({},"",window.location.pathname);const r=new URLSearchParams;r.set("f",e),window.history.replaceState({},"",`?${r.toString()}`)},[f,d]),v?p("div",{className:"flex items-center justify-center min-h-screen",children:m("div",{className:"text-center",children:[p(u,{className:"w-8 h-8 animate-spin text-primary-600 mx-auto mb-2"}),p("p",{className:"text-gray-600",children:"Loading data..."})]})}):N?p("div",{className:"flex items-center justify-center min-h-screen",children:m("div",{className:"text-center text-red-600",children:[p("p",{className:"font-semibold mb-2",children:"Error loading data"}),p("p",{className:"text-sm",children:N.message})]})}):m("div",{className:`flex min-h-screen bg-gray-50 ${y}`,children:[p(k,{schema:O,filters:f,onFilterChange:L}),p("div",{className:"flex-1 p-8",children:m("div",{className:"max-w-5xl mx-auto",children:[p(w,{schema:O,filters:f,onFilterChange:L,onRemoveFilter:L}),h&&h({filteredData:E,totalData:j,filters:f})]})})]})},O=new r,E=e=>p(t,{client:O,children:p(j,{...e})});export{E as DatasetFilter};
//# sourceMappingURL=index.esm.js.map
