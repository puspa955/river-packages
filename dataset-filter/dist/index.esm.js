import{useQuery as e,QueryClient as r,QueryClientProvider as t}from"@tanstack/react-query";import n,{useState as a,useMemo as l,useCallback as s,useEffect as i}from"react";import{ChevronDown as o,Search as c,X as d,SlidersHorizontal as h,Loader2 as u}from"lucide-react";import{jsxs as m,jsx as p}from"react/jsx-runtime";const f=({label:e,isNested:r=!1,children:t,defaultExpanded:n=!0})=>{const[l,s]=a(n);return m("div",{className:r?"":" mb-3 border-b border-gray-200",children:[m("button",{onClick:()=>s(!l),className:"w-full flex justify-between group",children:[p(r?"h4":"h3",{className:r?"text-xs font-medium text-gray-700 pb-2":"text-[13px] font-semibold text-gray-800 tracking-wide uppercase pb-2",children:e}),p(o,{className:"w-5 h-5 text-gray-600 hover:text-primary-600 transition-transform "+(l?"rotate-180":"")})]}),l&&p("div",{className:"mb-3 space-y-0.5",children:t})]})},g=({checked:e,onChange:r,label:t})=>m("label",{className:"flex items-start gap-3 cursor-pointer group w-fit",children:[p("input",{type:"checkbox",checked:e,onChange:r,className:"mt-0.5 w-4 h-4 rounded-sm border-gray-300 accent-primary-600 focus:ring-primary-500 cursor-pointer transition-colors group-hover:border-primary-600"}),p("span",{className:"text-sm text-gray-900 font-light group-hover:text-primary-600 transition-colors",children:t})]}),y=({config:e={},value:r=[],onChange:t,isNested:n=!1})=>{const[l,i]=a(!1),o=s(e=>{const n=r.includes(e)?r.filter(r=>r!==e):[...r,e];t(n.length?n:void 0)},[r,t]);if(!e.options||0===e.options.length)return null;const c=l?e.options:e.options.slice(0,5);return m(f,{label:e.label,isNested:n,children:[c.map(e=>p(g,{label:e,checked:(null==r?void 0:r.includes(e))||!1,onChange:()=>o(e)},e)),e.options.length>5&&p("button",{onClick:()=>i(!l),className:"mt-2 text-primary-600 hover:text-primary-500 text-xs inline-flex items-center gap-1 underline",children:l?"See less":"See all"})]})},b=({config:e,value:r=[],onChange:t,isNested:n=!1})=>{var a;const l=s(e=>{const n=r.includes(e)?r.filter(r=>r!==e):[...r,e];t(n.length?n:void 0)},[r,t]);return null!==(a=e.ranges)&&void 0!==a&&a.length?p(f,{label:e.label,isNested:n,children:e.ranges.map(e=>p(g,{label:e.label,checked:(null==r?void 0:r.includes(e.label))||!1,onChange:()=>l(e.label)},e.label))}):null},x=({config:e,value:r=!1,onChange:t})=>p("div",{children:p(g,{checked:!!r,onChange:e=>t(!!e.target.checked||void 0),label:e.label})}),v=({config:e,filters:r,onFilterChange:t,defaultExpanded:n=!0})=>e.children&&0!==e.children.length?p(f,{label:e.label,defaultExpanded:n,children:e.children.map(n=>{const a=e.childrenSchema[n];return a?"checkbox-group"===a.type?p(y,{config:a,value:r[n],onChange:e=>t(n,e),isNested:!0},n):"range"===a.type?p(b,{config:a,value:r[n],onChange:e=>t(n,e),isNested:!0},n):null:null})}):null,N=({schema:e,filters:r,onRemove:t})=>{const n=l(()=>{const t=[],n=e=>{Object.entries(e).forEach(([e,a])=>{if("group"===a.type&&a.childrenSchema)return void n(a.childrenSchema);const l=r[e];l&&("search"===a.type?t.push({key:e,label:l,type:"search"}):"checkbox"===a.type&&!0===l?t.push({key:e,label:a.label,type:"checkbox"}):Array.isArray(l)&&l.length>0&&l.forEach(r=>t.push({key:e,label:r,type:"array",value:r})))})};return n(e),t},[e,r]);return n.length?p("div",{className:"flex flex-wrap gap-2 mt-3",children:n.map(e=>m("span",{className:"inline-flex items-center gap-1.5 px-2 py-1 bg-primary-100/80 text-gray-700 text-sm border",children:[p("span",{children:e.label}),p("button",{onClick:()=>t(e),className:"hover:text-primary-600 rounded-full p-0.5 transition-colors",children:p(d,{className:"w-3.5 h-3.5"})})]},`${e.key}-${e.value||""}`))}):null},w=({schema:e,filters:r,onFilterChange:t})=>{const n=Object.entries(e).find(([e,r])=>"search"===r.type);if(!n)return null;const[a,l]=n,s=r[a]||"";return m("div",{className:"mb-6",children:[m("div",{className:"relative",children:[p(c,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),p("input",{type:"text",placeholder:l.placeholder,value:s,onChange:e=>t(a,e.target.value),className:"w-full pl-10 pr-10 py-3 border border-gray-400/70 focus:ring-1 focus:ring-primary-500 focus:border-transparent outline-none text-sm"}),s&&p("button",{onClick:()=>t(a,""),className:"absolute right-3 top-1/2 -translate-y-1/2",children:p(d,{className:"w-4 h-4 text-gray-400 hover:text-gray-600"})})]}),p(N,{schema:e,filters:r,onRemove:e=>{if("search"===e.type)t(e.key,"");else if("array"===e.type){const n=(r[e.key]||[]).filter(r=>r!==e.value);t(e.key,n.length?n:void 0)}else"checkbox"===e.type&&t(e.key,void 0)}})]})},k=({schema:e,filters:r,onFilterChange:t})=>{const[a,l]=n.useState(!0),s=Object.entries(e).filter(([,e])=>"checkbox"===e.type);return m("div",{className:"w-72 bg-white border-r border-gray-200 h-screen overflow-y-auto p-6 sticky top-0 custom-scroll",children:[m("div",{className:"flex items-center gap-2 mb-6",children:[p(h,{className:"w-5 h-5 text-primary-600"}),p("h2",{className:"text-lg font-semibold text-gray-900 tracking-tight",children:"Filters"})]}),s.length>0&&m("div",{className:"pb-3 mb-3 border-b border-gray-200",children:[m("button",{onClick:()=>l(!a),className:"w-full flex items-center justify-between group",children:[p("h3",{className:"text-[13px] font-semibold text-gray-800 tracking-wide uppercase",children:"General"}),p(o,{className:"w-5 h-5 text-gray-600 hover:text-primary-600 transition-transform "+(a?"rotate-180":"")})]}),a&&p("div",{className:"space-y-0.5 mt-2",children:s.map(([e,n])=>p(x,{config:n,value:r[e],onChange:r=>t(e,r)},e))})]}),Object.entries(e).map(([e,n])=>((e,n)=>"search"===n.type?null:"group"===n.type?p(v,{config:n,filters:r,onFilterChange:t},e):"checkbox-group"===n.type?p(y,{config:n,value:r[e],onChange:r=>t(e,r)},e):"range"===n.type?p(b,{config:n,value:r[e],onChange:r=>t(e,r)},e):null)(e,n))]})},C=(e,r)=>e&&r?r.split(".").reduce((e,r)=>null!=e?e[r]:null,e):null,S=e=>{try{const r=(e=>Object.fromEntries(Object.entries(e).filter(([,e])=>null!=e&&""!==e&&!(Array.isArray(e)&&0===e.length)&&!1!==e)))(e);return Object.keys(r).length?btoa(encodeURIComponent(JSON.stringify(r))):""}catch{return""}},A=e=>{const r={};let t=null;const n=e=>{Object.entries(e).forEach(([e,a])=>{if(!a)return;const l=String(a.type).toLowerCase();"group"===l&&a.childrenSchema?n(a.childrenSchema):"search"===l?t={key:e,config:a}:r[e]=a})};return n(e),{flat:r,search:t}},j={"checkbox-group":(e,r,t)=>{t.transform&&null!=e&&(e=t.transform(e));const n=Array.isArray(e)?e:[e],a=Array.isArray(r)?r:[r],l=n.map(e=>e?String(e).toLowerCase():e),s=a.map(e=>e?String(e).toLowerCase():e);if(s.includes("other")&&t.options){const e=t.options.map(e=>e.toLowerCase());if(l.some(r=>r&&!e.includes(r)))return!0}return s.some(e=>l.includes(e))},range:(e,r,t)=>{const n=Number(e);return!isNaN(n)&&r.some(e=>{var r;const a=null===(r=t.ranges)||void 0===r?void 0:r.find(r=>r.label===e);return!!a&&(n>=a.min&&n<=a.max)})},checkbox:(e,r)=>!r||!!e},O=(e,r)=>{const t=((e,r)=>{const{flat:t}=A(r),n={};return Object.entries(t).forEach(([r,t])=>{var a;if(null!==(a=t.options)&&void 0!==a&&a.length)return;if(!["checkbox-group","checkbox"].includes(t.type))return;const l=new Set;e.forEach(e=>{let r=C(e,t.field);t.transform&&null!=r&&(r=t.transform(r)),t.isArray&&Array.isArray(r)?r.forEach(e=>null!=e&&l.add(String(e))):null!=r&&l.add(String(r))}),n[r]=Array.from(l).sort()}),n})(r,e),n=e=>Object.fromEntries(Object.entries(e).map(([e,r])=>{var a;if(!r)return[e,r];const l={...r};return"group"===r.type&&r.childrenSchema?l.childrenSchema=n(r.childrenSchema):null!==(a=t[e])&&void 0!==a&&a.length&&(l.options=t[e]),[e,l]}));return n(e)},E=({schema:r,data:t=null,dataset:n=null,queryKey:o=null,queryFn:c=null,dataTransform:d=null,renderContent:h,enableUrlSync:f=!0,queryOptions:g={},className:y=""})=>{const[b,x]=a({}),v=s(async()=>{if(c)return c();if(!n)throw new Error("Either 'data', 'dataset', or 'queryFn' must be provided");const e=await fetch(n);if(!e.ok)throw new Error(`Failed to fetch data: ${e.statusText}`);return e.json()},[n,c]),N=s(e=>d?d(e):e?e.list||e.data||e:[],[d]),E=l(()=>o||(n?["dataset-url",n]:["dataset"]),[o,n]),F=Boolean(!t&&(n||c)),{data:L,isLoading:q,error:R}=e({queryKey:E,queryFn:v,enabled:F,staleTime:3e5,...g}),U=l(()=>t?Array.isArray(t)?t:[]:N(L)||[],[t,L,N]),$=l(()=>O(r,U),[r,U]),T=l(()=>((e,r,t)=>{if(!Array.isArray(e)||!e.length)return[];if(!r||!Object.keys(r).length)return e;const{flat:n,search:a}=A(t);return e.filter(e=>{var t;if(a&&null!==(t=r[a.key])&&void 0!==t&&t.trim()){const t=r[a.key].toLowerCase();if(!(Array.isArray(a.config.fields)?a.config.fields:[a.config.field]).some(r=>{const n=C(e,r);return Array.isArray(n)?n.some(e=>String(e||"").toLowerCase().includes(t)):String(n||"").toLowerCase().includes(t)}))return!1}return Object.entries(r).every(([r,t])=>{if(a&&r===a.key)return!0;if(!t||Array.isArray(t)&&!t.length)return!0;const l=n[r];if(!l)return!0;let s=C(e,l.field);const i=j[l.type];return!i||i(s,t,l)})})})(U,b,$),[U,b,$]),D=s((e,r)=>{x(t=>{const n={...t};return null==r||""===r||Array.isArray(r)&&0===r.length||!1===r?delete n[e]:n[e]=r,n})},[]);return i(()=>{if(!f)return;const e=new URLSearchParams(window.location.search).get("f");e&&x((e=>{try{return JSON.parse(decodeURIComponent(atob(e)))}catch{return{}}})(e))},[f]),i(()=>{if(!f)return;const e=S(b);if(!e)return void window.history.replaceState({},"",window.location.pathname);const r=new URLSearchParams;r.set("f",e),window.history.replaceState({},"",`?${r.toString()}`)},[b,f]),q?p("div",{className:"flex items-center justify-center min-h-screen",children:m("div",{className:"text-center",children:[p(u,{className:"w-8 h-8 animate-spin text-primary-600 mx-auto mb-2"}),p("p",{className:"text-gray-600",children:"Loading data..."})]})}):R?p("div",{className:"flex items-center justify-center min-h-screen",children:m("div",{className:"text-center text-red-600",children:[p("p",{className:"font-semibold mb-2",children:"Error loading data"}),p("p",{className:"text-sm",children:R.message})]})}):m("div",{className:`flex min-h-screen bg-gray-50 ${y}`,children:[p(k,{schema:$,filters:b,onFilterChange:D}),p("div",{className:"flex-1 p-8",children:m("div",{className:"max-w-5xl mx-auto",children:[p(w,{schema:$,filters:b,onFilterChange:D,onRemoveFilter:D}),h&&h({filteredData:T,totalData:U,filters:b})]})})]})},F=new r,L=e=>p(t,{client:F,children:p(E,{...e})});export{L as DatasetFilter};
//# sourceMappingURL=index.esm.js.map
