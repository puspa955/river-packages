import e,{useState as r,useMemo as t,useCallback as n,useEffect as a}from"react";import{useQuery as l}from"@tanstack/react-query";import{ChevronDown as s,Search as c,X as i,SlidersHorizontal as o,Loader2 as h}from"lucide-react";import{jsxs as d,jsx as m}from"react/jsx-runtime";const u=({label:e,isNested:t=!1,children:n,defaultExpanded:a=!0})=>{const[l,c]=r(a);return d("div",{className:t?"":" mb-3 border-b border-gray-200",children:[d("button",{onClick:()=>c(!l),className:"w-full flex justify-between group",children:[m(t?"h4":"h3",{className:t?"text-xs font-medium text-gray-700 pb-2":"text-[13px] font-semibold text-gray-800 tracking-wide uppercase pb-2",children:e}),m(s,{className:"w-5 h-5 text-gray-600 hover:text-primary-600 transition-transform "+(l?"rotate-180":"")})]}),l&&m("div",{className:"mb-3 space-y-0.5",children:n})]})},p=({checked:e,onChange:r,label:t})=>d("label",{className:"flex items-start gap-3 cursor-pointer group w-fit",children:[m("input",{type:"checkbox",checked:e,onChange:r,className:"mt-0.5 w-4 h-4 rounded-sm border-gray-300 accent-primary-600 focus:ring-primary-500 cursor-pointer transition-colors group-hover:border-primary-600"}),m("span",{className:"text-sm text-gray-900 font-light group-hover:text-primary-600 transition-colors",children:t})]}),g=({config:e={},value:t=[],onChange:a,isNested:l=!1})=>{const[s,c]=r(!1),i=n(e=>{const r=t.includes(e)?t.filter(r=>r!==e):[...t,e];a(r.length?r:void 0)},[t,a]);if(!e.options||0===e.options.length)return null;const o=s?e.options:e.options.slice(0,5);return d(u,{label:e.label,isNested:l,children:[o.map(e=>m(p,{label:e,checked:(null==t?void 0:t.includes(e))||!1,onChange:()=>i(e)},e)),e.options.length>5&&m("button",{onClick:()=>c(!s),className:"mt-2 text-primary-600 hover:text-primary-500 text-xs inline-flex items-center gap-1 underline",children:s?"See less":"See all"})]})},f=({config:e,value:r=[],onChange:t,isNested:a=!1})=>{var l;const s=n(e=>{const n=r.includes(e)?r.filter(r=>r!==e):[...r,e];t(n.length?n:void 0)},[r,t]);return null!==(l=e.ranges)&&void 0!==l&&l.length?m(u,{label:e.label,isNested:a,children:e.ranges.map(e=>m(p,{label:e.label,checked:(null==r?void 0:r.includes(e.label))||!1,onChange:()=>s(e.label)},e.label))}):null},y=({config:e,value:r=!1,onChange:t})=>m("div",{children:m(p,{checked:!!r,onChange:e=>t(!!e.target.checked||void 0),label:e.label})}),b=({config:e,filters:r,onFilterChange:t,defaultExpanded:n=!0})=>e.children&&0!==e.children.length?m(u,{label:e.label,defaultExpanded:n,children:e.children.map(n=>{const a=e.childrenSchema[n];return a?"checkbox-group"===a.type?m(g,{config:a,value:r[n],onChange:e=>t(n,e),isNested:!0},n):"range"===a.type?m(f,{config:a,value:r[n],onChange:e=>t(n,e),isNested:!0},n):null:null})}):null,x=({schema:e,filters:r,onRemove:n})=>{const a=t(()=>{const t=[],n=e=>{Object.entries(e).forEach(([e,a])=>{if("group"===a.type&&a.childrenSchema)return void n(a.childrenSchema);const l=r[e];l&&("search"===a.type?t.push({key:e,label:l,type:"search"}):"checkbox"===a.type&&!0===l?t.push({key:e,label:a.label,type:"checkbox"}):Array.isArray(l)&&l.length>0&&l.forEach(r=>t.push({key:e,label:r,type:"array",value:r})))})};return n(e),t},[e,r]);return a.length?m("div",{className:"flex flex-wrap gap-2 mt-3",children:a.map(e=>d("span",{className:"inline-flex items-center gap-1.5 px-2 py-1 bg-primary-100/80 text-gray-700 text-sm border",children:[m("span",{children:e.label}),m("button",{onClick:()=>n(e),className:"hover:text-primary-600 rounded-full p-0.5 transition-colors",children:m(i,{className:"w-3.5 h-3.5"})})]},`${e.key}-${e.value||""}`))}):null},v=({schema:e,filters:r,onFilterChange:t})=>{const n=Object.entries(e).find(([e,r])=>"search"===r.type);if(!n)return null;const[a,l]=n,s=r[a]||"";return d("div",{className:"mb-6",children:[d("div",{className:"relative",children:[m(c,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),m("input",{type:"text",placeholder:l.placeholder,value:s,onChange:e=>t(a,e.target.value),className:"w-full pl-10 pr-10 py-3 border border-gray-400/70 focus:ring-1 focus:ring-primary-500 focus:border-transparent outline-none text-sm"}),s&&m("button",{onClick:()=>t(a,""),className:"absolute right-3 top-1/2 -translate-y-1/2",children:m(i,{className:"w-4 h-4 text-gray-400 hover:text-gray-600"})})]}),m(x,{schema:e,filters:r,onRemove:e=>{if("search"===e.type)t(e.key,"");else if("array"===e.type){const n=(r[e.key]||[]).filter(r=>r!==e.value);t(e.key,n.length?n:void 0)}else"checkbox"===e.type&&t(e.key,void 0)}})]})},N=({schema:r,filters:t,onFilterChange:n})=>{const[a,l]=e.useState(!0),c=Object.entries(r).filter(([,e])=>"checkbox"===e.type);return d("div",{className:"w-72 bg-white border-r border-gray-200 h-screen overflow-y-auto p-6 sticky top-0 custom-scroll",children:[d("div",{className:"flex items-center gap-2 mb-6",children:[m(o,{className:"w-5 h-5 text-primary-600"}),m("h2",{className:"text-lg font-semibold text-gray-900 tracking-tight",children:"Filters"})]}),c.length>0&&d("div",{className:"pb-3 mb-3 border-b border-gray-200",children:[d("button",{onClick:()=>l(!a),className:"w-full flex items-center justify-between group",children:[m("h3",{className:"text-[13px] font-semibold text-gray-800 tracking-wide uppercase",children:"General"}),m(s,{className:"w-5 h-5 text-gray-600 hover:text-primary-600 transition-transform "+(a?"rotate-180":"")})]}),a&&m("div",{className:"space-y-0.5 mt-2",children:c.map(([e,r])=>m(y,{config:r,value:t[e],onChange:r=>n(e,r)},e))})]}),Object.entries(r).map(([e,r])=>((e,r)=>"search"===r.type?null:"group"===r.type?m(b,{config:r,filters:t,onFilterChange:n},e):"checkbox-group"===r.type?m(g,{config:r,value:t[e],onChange:r=>n(e,r)},e):"range"===r.type?m(f,{config:r,value:t[e],onChange:r=>n(e,r)},e):null)(e,r))]})},w=(e,r)=>r&&e?r.split(".").reduce((e,r)=>null==e?null:e[r],e):null,k=(e,r)=>{const t=((e,r)=>{const t={},n={};var a;return a=r,Object.entries(a).forEach(([e,r])=>{"group"===r.type&&r.childrenSchema?Object.entries(r.childrenSchema).forEach(([e,r])=>{n[e]=r}):n[e]=r}),Object.entries(n).forEach(([r,n])=>{if(n.options&&n.options.length>0)return;if(!["checkbox-group","select","checkbox"].includes(n.type))return;const a=new Set;e.forEach(e=>{let r=w(e,n.field);n.transform&&null!=r&&(r=n.transform(r)),n.isArray&&Array.isArray(r)?r.forEach(e=>null!==e&&a.add(String(e))):null!=r&&a.add(String(r))}),t[r]=Array.from(a).sort()}),t})(r,e),n={};return Object.entries(e).forEach(([e,r])=>{n[e]={...r},"group"===r.type&&r.childrenSchema?(n[e].childrenSchema={},Object.entries(r.childrenSchema).forEach(([r,a])=>{n[e].childrenSchema[r]={...a},t[r]&&t[r].length>0&&(n[e].childrenSchema[r].options=t[r])})):t[e]&&t[e].length>0&&(n[e].options=t[e])}),n},C=e=>{try{const r=(e=>{const r={};return Object.entries(e).forEach(([e,t])=>{null==t||""===t||Array.isArray(t)&&0===t.length||!1===t||(r[e]=t)}),r})(e);if(0===Object.keys(r).length)return"";const t=JSON.stringify(r);return btoa(encodeURIComponent(t))}catch(e){return""}},S=({schema:e,data:s=[],queryKey:c,queryFn:i,dataTransform:o=e=>e,renderContent:u,enableUrlSync:p=!0,queryOptions:g={},className:f=""})=>{const[y,b]=r({}),{data:x,isLoading:S,error:j}=l({queryKey:c||["dataset"],queryFn:i||(()=>Promise.resolve({data:s})),enabled:!!i,...g}),A=i?o(x)||[]:s,O=t(()=>k(e,A),[e,A]),E=t(()=>((e,r,t)=>{const n={};var a;return a=t,Object.entries(a).forEach(([e,r])=>{"group"===r.type&&r.childrenSchema?Object.entries(r.childrenSchema).forEach(([e,r])=>{n[e]=r}):"search"!==r.type&&(n[e]=r)}),e.filter(e=>Object.entries(r).every(([r,t])=>{if(!t||Array.isArray(t)&&0===t.length)return!0;const a=n[r];if(!a)return!0;let l=w(e,a.field);switch(a.type){case"search":return(Array.isArray(a.fields)?a.fields:[a.field]).some(r=>{const n=w(e,r);return String(n||"").toLowerCase().includes(t.toLowerCase())});case"checkbox-group":{a.transform&&null!=l&&(l=a.transform(l));const e=Array.isArray(l)?l:[l],r=Array.isArray(t)?t:[t],n=e.map(e=>e?String(e).toLowerCase():e),s=r.map(e=>e?String(e).toLowerCase():e);if(s.includes("other")&&a.options){const e=a.options.map(e=>e.toLowerCase());if(n.some(r=>r&&!e.includes(r)))return!0}return s.some(e=>n.includes(e))}case"range":{const e=Number(l);return!isNaN(e)&&null!=l&&t.some(r=>{const t=a.ranges.find(e=>e.label===r);return!!t&&e>=t.min&&e<=t.max})}case"checkbox":return!t||!!l;case"select":{if(!l)return!1;const e=String(l).toLowerCase(),r=String(t).toLowerCase();return"other"===r&&a.options?!a.options.map(e=>e.toLowerCase()).includes(e):e===r}default:return!0}}))})(A,y,O),[A,y,O]),L=n((e,r)=>{b(t=>{const n={...t};return null==r||""===r||Array.isArray(r)&&0===r.length||!1===r?delete n[e]:n[e]=r,n})},[]);return a(()=>{if(!p)return;const e=new URLSearchParams(window.location.search).get("f");e&&b((e=>{try{const r=decodeURIComponent(atob(e));return JSON.parse(r)}catch(e){return{}}})(e))},[p]),a(()=>{if(!p)return;const e=C(y);if(!e)return void window.history.replaceState({},"",window.location.pathname);const r=new URLSearchParams;r.set("f",e),window.history.replaceState({},"",`?${r.toString()}`)},[y,p]),S?m("div",{className:"flex items-center justify-center min-h-screen",children:d("div",{className:"text-center",children:[m(h,{className:"w-8 h-8 animate-spin text-primary-600 mx-auto mb-2"}),m("p",{className:"text-gray-600",children:"Loading data..."})]})}):j?m("div",{className:"flex items-center justify-center min-h-screen",children:d("div",{className:"text-center text-red-600",children:[m("p",{className:"font-semibold mb-2",children:"Error loading data"}),m("p",{className:"text-sm",children:j.message})]})}):d("div",{className:`flex min-h-screen bg-gray-50 ${f}`,children:[m(N,{schema:O,filters:y,onFilterChange:L}),m("div",{className:"flex-1 p-8",children:d("div",{className:"max-w-5xl mx-auto",children:[m(v,{schema:O,filters:y,onFilterChange:L,onRemoveFilter:L}),u&&u({filteredData:E,totalData:A,filters:y})]})})]})};export{S as DatasetFilter};
//# sourceMappingURL=index.esm.js.map
