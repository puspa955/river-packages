"use strict";var e=require("@tanstack/react-query"),r=require("react"),t=require("lucide-react"),n=require("react/jsx-runtime");const s=({label:e,isNested:s=!1,children:a,defaultExpanded:l=!0})=>{const[i,c]=r.useState(l),o=s?"h4":"h3",u=s?"text-xs font-medium text-gray-700 pb-2":"text-[13px] font-semibold text-gray-800 tracking-wide uppercase pb-2",d=s?"":" mb-3 border-b border-gray-200";return n.jsxs("div",{className:d,children:[n.jsxs("button",{onClick:()=>c(!i),className:"w-full flex justify-between group",children:[n.jsx(o,{className:u,children:e}),n.jsx(t.ChevronDown,{className:"w-5 h-5 text-gray-600 hover:text-primary-600 transition-transform "+(i?"rotate-180":"")})]}),i&&n.jsx("div",{className:"mb-3 space-y-0.5",children:a})]})},a=({checked:e,onChange:r,label:t})=>n.jsxs("label",{className:"flex items-start gap-3 cursor-pointer group w-fit",children:[n.jsx("input",{type:"checkbox",checked:e,onChange:r,className:"mt-0.5 w-4 h-4 rounded-sm border-gray-300 accent-primary-600 focus:ring-primary-500 cursor-pointer transition-colors group-hover:border-primary-600"}),n.jsx("span",{className:"text-sm text-gray-900 font-light group-hover:text-primary-600 transition-colors",children:t})]}),l=({config:e={},value:t=[],onChange:l,isNested:i=!1})=>{const[c,o]=r.useState(!1),u=r.useCallback(e=>{const r=t.includes(e)?t.filter(r=>r!==e):[...t,e];l(r.length?r:void 0)},[t,l]);if(!e.options||0===e.options.length)return null;const d=c?e.options:e.options.slice(0,5);return n.jsxs(s,{label:e.label,isNested:i,children:[d.map(e=>n.jsx(a,{label:e,checked:(null==t?void 0:t.includes(e))||!1,onChange:()=>u(e)},e)),e.options.length>5&&n.jsx("button",{onClick:()=>o(!c),className:"mt-2 text-primary-600 hover:text-primary-500 text-xs inline-flex items-center gap-1 underline",children:c?"See less":"See all"})]})},i=({config:e,value:t=[],onChange:l,isNested:i=!1})=>{var c;const o=r.useCallback(e=>{const r=t.includes(e)?t.filter(r=>r!==e):[...t,e];l(r.length?r:void 0)},[t,l]);return null!==(c=e.ranges)&&void 0!==c&&c.length?n.jsx(s,{label:e.label,isNested:i,children:e.ranges.map(e=>n.jsx(a,{label:e.label,checked:(null==t?void 0:t.includes(e.label))||!1,onChange:()=>o(e.label)},e.label))}):null},c=({config:e,value:r=!1,onChange:t})=>n.jsx("div",{children:n.jsx(a,{checked:!!r,onChange:e=>t(!!e.target.checked||void 0),label:e.label})}),o=({config:e,filters:r,onFilterChange:t,defaultExpanded:a=!0})=>e.children&&0!==e.children.length?n.jsx(s,{label:e.label,defaultExpanded:a,children:e.children.map(s=>{const a=e.childrenSchema[s];return a?"checkbox-group"===a.type?n.jsx(l,{config:a,value:r[s],onChange:e=>t(s,e),isNested:!0},s):"range"===a.type?n.jsx(i,{config:a,value:r[s],onChange:e=>t(s,e),isNested:!0},s):null:null})}):null,u=({schema:e,filters:s,onRemove:a})=>{const l=r.useMemo(()=>{const r=[],t=e=>{Object.entries(e).forEach(([e,n])=>{if("group"===n.type&&n.childrenSchema)return void t(n.childrenSchema);const a=s[e];a&&("search"===n.type?r.push({key:e,label:a,type:"search"}):"checkbox"===n.type&&!0===a?r.push({key:e,label:n.label,type:"checkbox"}):Array.isArray(a)&&a.length>0&&a.forEach(t=>r.push({key:e,label:t,type:"array",value:t})))})};return t(e),r},[e,s]);return l.length?n.jsx("div",{className:"flex flex-wrap gap-2 mt-3",children:l.map(e=>n.jsxs("span",{className:"inline-flex items-center gap-1.5 px-2 py-1 bg-primary-100/80 text-gray-700 text-sm border",children:[n.jsx("span",{children:e.label}),n.jsx("button",{onClick:()=>a(e),className:"hover:text-primary-600 rounded-full p-0.5 transition-colors",children:n.jsx(t.X,{className:"w-3.5 h-3.5"})})]},`${e.key}-${e.value||""}`))}):null},d=({schema:e,filters:r,onFilterChange:s})=>{const a=Object.entries(e).find(([e,r])=>"search"===r.type);if(!a)return null;const[l,i]=a,c=r[l]||"";return n.jsxs("div",{className:"mb-6",children:[n.jsxs("div",{className:"relative",children:[n.jsx(t.Search,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),n.jsx("input",{type:"text",placeholder:i.placeholder,value:c,onChange:e=>s(l,e.target.value),className:"w-full pl-10 pr-10 py-3 border border-gray-400/70 focus:ring-1 focus:ring-primary-500 focus:border-transparent outline-none text-sm"}),c&&n.jsx("button",{onClick:()=>s(l,""),className:"absolute right-3 top-1/2 -translate-y-1/2",children:n.jsx(t.X,{className:"w-4 h-4 text-gray-400 hover:text-gray-600"})})]}),n.jsx(u,{schema:e,filters:r,onRemove:e=>{if("search"===e.type)s(e.key,"");else if("array"===e.type){const t=(r[e.key]||[]).filter(r=>r!==e.value);s(e.key,t.length?t:void 0)}else"checkbox"===e.type&&s(e.key,void 0)}})]})},h=({schema:e,filters:s,onFilterChange:a})=>{const[u,d]=r.useState(!0),h=Object.entries(e).filter(([,e])=>"checkbox"===e.type);return n.jsxs("div",{className:"w-72 bg-white border-r border-gray-200 h-screen overflow-y-auto p-6 sticky top-0 custom-scroll",children:[n.jsxs("div",{className:"flex items-center gap-2 mb-6",children:[n.jsx(t.SlidersHorizontal,{className:"w-5 h-5 text-primary-600"}),n.jsx("h2",{className:"text-lg font-semibold text-gray-900 tracking-tight",children:"Filters"})]}),h.length>0&&n.jsxs("div",{className:"pb-3 mb-3 border-b border-gray-200",children:[n.jsxs("button",{onClick:()=>d(!u),className:"w-full flex items-center justify-between group",children:[n.jsx("h3",{className:"text-[13px] font-semibold text-gray-800 tracking-wide uppercase",children:"General"}),n.jsx(t.ChevronDown,{className:"w-5 h-5 text-gray-600 hover:text-primary-600 transition-transform "+(u?"rotate-180":"")})]}),u&&n.jsx("div",{className:"space-y-0.5 mt-2",children:h.map(([e,r])=>n.jsx(c,{config:r,value:s[e],onChange:r=>a(e,r)},e))})]}),Object.entries(e).map(([e,r])=>((e,r)=>"search"===r.type?null:"group"===r.type?n.jsx(o,{config:r,filters:s,onFilterChange:a},e):"checkbox-group"===r.type?n.jsx(l,{config:r,value:s[e],onChange:r=>a(e,r)},e):"range"===r.type?n.jsx(i,{config:r,value:s[e],onChange:r=>a(e,r)},e):null)(e,r))]})},m=(e,r)=>e&&r?r.split(".").reduce((e,r)=>null!=e?e[r]:null,e):null,x=e=>{try{const r=(e=>Object.fromEntries(Object.entries(e).filter(([,e])=>null!=e&&""!==e&&!(Array.isArray(e)&&0===e.length)&&!1!==e)))(e);return Object.keys(r).length?btoa(encodeURIComponent(JSON.stringify(r))):""}catch{return""}},p=e=>{const r={};let t=null;const n=e=>{Object.entries(e).forEach(([e,s])=>{if(!s)return;const a=String(s.type).toLowerCase();"group"===a&&s.childrenSchema?n(s.childrenSchema):"search"===a?t={key:e,config:s}:r[e]=s})};return n(e),{flat:r,search:t}},y={"checkbox-group":(e,r,t)=>{t.transform&&null!=e&&(e=t.transform(e));const n=Array.isArray(e)?e:[e],s=Array.isArray(r)?r:[r],a=n.map(e=>e?String(e).toLowerCase():e),l=s.map(e=>e?String(e).toLowerCase():e);if(l.includes("other")&&t.options){const e=t.options.map(e=>e.toLowerCase());if(a.some(r=>r&&!e.includes(r)))return!0}return l.some(e=>a.includes(e))},range:(e,r,t)=>{const n=Number(e);return!isNaN(n)&&r.some(e=>{var r;const s=null===(r=t.ranges)||void 0===r?void 0:r.find(r=>r.label===e);return!!s&&(n>=s.min&&n<=s.max)})},checkbox:(e,r)=>!r||!!e},f=(e,r)=>{const t=((e,r)=>{const{flat:t}=p(r),n={};return Object.entries(t).forEach(([r,t])=>{var s;if(null!==(s=t.options)&&void 0!==s&&s.length)return;if(!["checkbox-group","checkbox"].includes(t.type))return;const a=new Set;e.forEach(e=>{let r=m(e,t.field);t.transform&&null!=r&&(r=t.transform(r)),t.isArray&&Array.isArray(r)?r.forEach(e=>null!=e&&a.add(String(e))):null!=r&&a.add(String(r))}),n[r]=Array.from(a).sort()}),n})(r,e),n=e=>Object.fromEntries(Object.entries(e).map(([e,r])=>{var s;if(!r)return[e,r];const a={...r};return"group"===r.type&&r.childrenSchema?a.childrenSchema=n(r.childrenSchema):null!==(s=t[e])&&void 0!==s&&s.length&&(a.options=t[e]),[e,a]}));return n(e)},g=({schema:s,data:a=null,url:l=null,queryKey:i=null,queryFn:c=null,dataTransform:o=null,renderContent:u,enableUrlSync:g=!0,queryOptions:b={},className:j=""})=>{const[v,N]=r.useState({}),k=!a&&(l||c),w=r.useCallback(async()=>{if(c)return c();if(!l)throw new Error("Either data, url, or queryFn must be provided");const e=await fetch(l);if(!e.ok)throw new Error(`Failed to fetch data: ${e.statusText}`);return e.json()},[l,c]),C=r.useCallback(e=>o?o(e):e?e.list||e.data||e:[],[o]),S=r.useMemo(()=>i||(l?["dataset-url",l]:["dataset"]),[i,l]),{data:A,isLoading:E,error:O}=e.useQuery({queryKey:S,queryFn:w,enabled:k,staleTime:3e5,...b}),F=r.useMemo(()=>a?Array.isArray(a)?a:[]:C(A)||[],[a,A,C]),L=r.useMemo(()=>f(s,F),[s,F]),q=r.useMemo(()=>((e,r,t)=>{if(!Array.isArray(e)||!e.length)return[];if(!r||!Object.keys(r).length)return e;const{flat:n,search:s}=p(t);return e.filter(e=>{var t;if(s&&null!==(t=r[s.key])&&void 0!==t&&t.trim()){const t=r[s.key].toLowerCase();if(!(Array.isArray(s.config.fields)?s.config.fields:[s.config.field]).some(r=>{const n=m(e,r);return Array.isArray(n)?n.some(e=>String(e||"").toLowerCase().includes(t)):String(n||"").toLowerCase().includes(t)}))return!1}return Object.entries(r).every(([r,t])=>{if(s&&r===s.key)return!0;if(!t||Array.isArray(t)&&!t.length)return!0;const a=n[r];if(!a)return!0;let l=m(e,a.field);const i=y[a.type];return!i||i(l,t,a)})})})(F,v,L),[F,v,L]),R=r.useCallback((e,r)=>{N(t=>{const n={...t};return null==r||""===r||Array.isArray(r)&&0===r.length||!1===r?delete n[e]:n[e]=r,n})},[]);return r.useEffect(()=>{if(!g)return;const e=new URLSearchParams(window.location.search).get("f");e&&N((e=>{try{return JSON.parse(decodeURIComponent(atob(e)))}catch{return{}}})(e))},[g]),r.useEffect(()=>{if(!g)return;const e=x(v);if(!e)return void window.history.replaceState({},"",window.location.pathname);const r=new URLSearchParams;r.set("f",e),window.history.replaceState({},"",`?${r.toString()}`)},[v,g]),E?n.jsx("div",{className:"flex items-center justify-center min-h-screen",children:n.jsxs("div",{className:"text-center",children:[n.jsx(t.Loader2,{className:"w-8 h-8 animate-spin text-primary-600 mx-auto mb-2"}),n.jsx("p",{className:"text-gray-600",children:"Loading data..."})]})}):O?n.jsx("div",{className:"flex items-center justify-center min-h-screen",children:n.jsxs("div",{className:"text-center text-red-600",children:[n.jsx("p",{className:"font-semibold mb-2",children:"Error loading data"}),n.jsx("p",{className:"text-sm",children:O.message})]})}):n.jsxs("div",{className:`flex min-h-screen bg-gray-50 ${j}`,children:[n.jsx(h,{schema:L,filters:v,onFilterChange:R}),n.jsx("div",{className:"flex-1 p-8",children:n.jsxs("div",{className:"max-w-5xl mx-auto",children:[n.jsx(d,{schema:L,filters:v,onFilterChange:R,onRemoveFilter:R}),u&&u({filteredData:q,totalData:F,filters:v})]})})]})},b=new e.QueryClient;exports.DatasetFilter=r=>n.jsx(e.QueryClientProvider,{client:b,children:n.jsx(g,{...r})});
//# sourceMappingURL=index.js.map
