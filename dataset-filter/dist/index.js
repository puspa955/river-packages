"use strict";var e=require("@tanstack/react-query"),r=require("react"),t=require("lucide-react"),s=require("react/jsx-runtime");const n=({label:e,isNested:n=!1,children:a,defaultExpanded:l=!0})=>{const[i,o]=r.useState(l),c=n?"h4":"h3",h=n?"text-xs font-medium text-gray-700 pb-2":"text-[13px] font-semibold text-gray-800 tracking-wide uppercase pb-2",u=n?"":" mb-3 border-b border-gray-200";return s.jsxs("div",{className:u,children:[s.jsxs("button",{onClick:()=>o(!i),className:"w-full flex justify-between group",children:[s.jsx(c,{className:h,children:e}),s.jsx(t.ChevronDown,{className:"w-5 h-5 text-gray-600 hover:text-primary-600 transition-transform "+(i?"rotate-180":"")})]}),i&&s.jsx("div",{className:"mb-3 space-y-0.5",children:a})]})},a=({checked:e,onChange:r,label:t})=>s.jsxs("label",{className:"flex items-start gap-3 cursor-pointer group w-fit",children:[s.jsx("input",{type:"checkbox",checked:e,onChange:r,className:"mt-0.5 w-4 h-4 rounded-sm border-gray-300 accent-primary-600 focus:ring-primary-500 cursor-pointer transition-colors group-hover:border-primary-600"}),s.jsx("span",{className:"text-sm text-gray-900 font-light group-hover:text-primary-600 transition-colors",children:t})]}),l=({config:e={},value:t=[],onChange:l,isNested:i=!1})=>{const[o,c]=r.useState(!1),h=r.useCallback(e=>{const r=t.includes(e)?t.filter(r=>r!==e):[...t,e];l(r.length?r:void 0)},[t,l]);if(!e.options||0===e.options.length)return null;const u=o?e.options:e.options.slice(0,5);return s.jsxs(n,{label:e.label,isNested:i,children:[u.map(e=>s.jsx(a,{label:e,checked:(null==t?void 0:t.includes(e))||!1,onChange:()=>h(e)},e)),e.options.length>5&&s.jsx("button",{onClick:()=>c(!o),className:"mt-2 text-primary-600 hover:text-primary-500 text-xs inline-flex items-center gap-1 underline",children:o?"See less":"See all"})]})},i=({config:e,value:t=[],onChange:l,isNested:i=!1})=>{var o;const c=r.useCallback(e=>{const r=t.includes(e)?t.filter(r=>r!==e):[...t,e];l(r.length?r:void 0)},[t,l]);return null!==(o=e.ranges)&&void 0!==o&&o.length?s.jsx(n,{label:e.label,isNested:i,children:e.ranges.map(e=>s.jsx(a,{label:e.label,checked:(null==t?void 0:t.includes(e.label))||!1,onChange:()=>c(e.label)},e.label))}):null},o=({config:e,value:r=!1,onChange:t})=>s.jsx("div",{children:s.jsx(a,{checked:!!r,onChange:e=>t(!!e.target.checked||void 0),label:e.label})}),c=({config:e,filters:r,onFilterChange:t,defaultExpanded:a=!0})=>e.children&&0!==e.children.length?s.jsx(n,{label:e.label,defaultExpanded:a,children:e.children.map(n=>{const a=e.childrenSchema[n];return a?"checkbox-group"===a.type?s.jsx(l,{config:a,value:r[n],onChange:e=>t(n,e),isNested:!0},n):"range"===a.type?s.jsx(i,{config:a,value:r[n],onChange:e=>t(n,e),isNested:!0},n):null:null})}):null,h=({schema:e,filters:n,onRemove:a})=>{const l=r.useMemo(()=>{const r=[],t=e=>{Object.entries(e).forEach(([e,s])=>{if("group"===s.type&&s.childrenSchema)return void t(s.childrenSchema);const a=n[e];a&&("search"===s.type?r.push({key:e,label:a,type:"search"}):"checkbox"===s.type&&!0===a?r.push({key:e,label:s.label,type:"checkbox"}):Array.isArray(a)&&a.length>0&&a.forEach(t=>r.push({key:e,label:t,type:"array",value:t})))})};return t(e),r},[e,n]);return l.length?s.jsx("div",{className:"flex flex-wrap gap-2 mt-3",children:l.map(e=>s.jsxs("span",{className:"inline-flex items-center gap-1.5 px-2 py-1 bg-primary-100/80 text-gray-700 text-sm border",children:[s.jsx("span",{children:e.label}),s.jsx("button",{onClick:()=>a(e),className:"hover:text-primary-600 rounded-full p-0.5 transition-colors",children:s.jsx(t.X,{className:"w-3.5 h-3.5"})})]},`${e.key}-${e.value||""}`))}):null},u=({schema:e,filters:r,onFilterChange:n})=>{const a=Object.entries(e).find(([e,r])=>"search"===r.type);if(!a)return null;const[l,i]=a,o=r[l]||"";return s.jsxs("div",{className:"mb-6",children:[s.jsxs("div",{className:"relative",children:[s.jsx(t.Search,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),s.jsx("input",{type:"text",placeholder:i.placeholder,value:o,onChange:e=>n(l,e.target.value),className:"w-full pl-10 pr-10 py-3 border border-gray-400/70 focus:ring-1 focus:ring-primary-500 focus:border-transparent outline-none text-sm"}),o&&s.jsx("button",{onClick:()=>n(l,""),className:"absolute right-3 top-1/2 -translate-y-1/2",children:s.jsx(t.X,{className:"w-4 h-4 text-gray-400 hover:text-gray-600"})})]}),s.jsx(h,{schema:e,filters:r,onRemove:e=>{if("search"===e.type)n(e.key,"");else if("array"===e.type){const t=(r[e.key]||[]).filter(r=>r!==e.value);n(e.key,t.length?t:void 0)}else"checkbox"===e.type&&n(e.key,void 0)}})]})},d=({schema:e,filters:n,onFilterChange:a})=>{const[h,u]=r.useState(!0),d=Object.entries(e).filter(([,e])=>"checkbox"===e.type);return s.jsxs("div",{className:"w-72 bg-white border-r border-gray-200 h-screen overflow-y-auto p-6 sticky top-0 custom-scroll",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-6",children:[s.jsx(t.SlidersHorizontal,{className:"w-5 h-5 text-primary-600"}),s.jsx("h2",{className:"text-lg font-semibold text-gray-900 tracking-tight",children:"Filters"})]}),d.length>0&&s.jsxs("div",{className:"pb-3 mb-3 border-b border-gray-200",children:[s.jsxs("button",{onClick:()=>u(!h),className:"w-full flex items-center justify-between group",children:[s.jsx("h3",{className:"text-[13px] font-semibold text-gray-800 tracking-wide uppercase",children:"General"}),s.jsx(t.ChevronDown,{className:"w-5 h-5 text-gray-600 hover:text-primary-600 transition-transform "+(h?"rotate-180":"")})]}),h&&s.jsx("div",{className:"space-y-0.5 mt-2",children:d.map(([e,r])=>s.jsx(o,{config:r,value:n[e],onChange:r=>a(e,r)},e))})]}),Object.entries(e).map(([e,r])=>((e,r)=>"search"===r.type?null:"group"===r.type?s.jsx(c,{config:r,filters:n,onFilterChange:a},e):"checkbox-group"===r.type?s.jsx(l,{config:r,value:n[e],onChange:r=>a(e,r)},e):"range"===r.type?s.jsx(i,{config:r,value:n[e],onChange:r=>a(e,r)},e):null)(e,r))]})},m=(e,r)=>e&&r?r.split(".").reduce((e,r)=>null!=e?e[r]:null,e):null,y=e=>{try{const r=(e=>Object.fromEntries(Object.entries(e).filter(([,e])=>null!=e&&""!==e&&!(Array.isArray(e)&&0===e.length)&&!1!==e)))(e);return Object.keys(r).length?btoa(encodeURIComponent(JSON.stringify(r))):""}catch{return""}},f=e=>{const r={};let t=null;const s=e=>{e&&"object"==typeof e&&Object.entries(e).forEach(([e,n])=>{if(!n)return;const a=String(n.type).toLowerCase();"group"===a&&n.childrenSchema?s(n.childrenSchema):"search"===a?t={key:e,config:n}:r[e]=n})};return s(e),{flat:r,search:t}},x={"checkbox-group":(e,r,t)=>{t.transform&&null!=e&&(e=t.transform(e));const s=Array.isArray(e)?e:[e],n=Array.isArray(r)?r:[r],a=s.map(e=>e?String(e).toLowerCase():e),l=n.map(e=>e?String(e).toLowerCase():e);if(l.includes("other")&&t.options){const e=t.options.map(e=>e.toLowerCase());if(a.some(r=>r&&!e.includes(r)))return!0}return l.some(e=>a.includes(e))},range:(e,r,t)=>{const s=Number(e);return!isNaN(s)&&r.some(e=>{var r;const n=null===(r=t.ranges)||void 0===r?void 0:r.find(r=>r.label===e);return!!n&&(s>=n.min&&s<=n.max)})},checkbox:(e,r)=>!r||!!e},p=(e,r)=>{r&&Array.isArray(r)||(console.warn("updateSchemaWithDynamicOptions: data must be an array, received:",typeof r),r=[]);const t=((e,r)=>{if(!e||!Array.isArray(e))return console.warn("extractDynamicOptions: data must be an array, received:",typeof e),{};if(!e.length)return{};const{flat:t}=f(r),s={};return t&&"object"==typeof t?(Object.entries(t).forEach(([r,t])=>{var n;if(!t)return;if(null!==(n=t.options)&&void 0!==n&&n.length)return;if(!["checkbox-group","checkbox"].includes(t.type))return;const a=new Set;Array.isArray(e)&&e.forEach(e=>{let r=m(e,t.field);t.transform&&null!=r&&(r=t.transform(r)),t.isArray&&Array.isArray(r)?r.forEach(e=>null!=e&&a.add(String(e))):null!=r&&a.add(String(r))}),s[r]=Array.from(a).sort()}),s):{}})(r,e),s=e=>e&&"object"==typeof e?Object.fromEntries(Object.entries(e).map(([e,r])=>{var n;if(!r)return[e,r];const a={...r};return"group"===r.type&&r.childrenSchema?a.childrenSchema=s(r.childrenSchema):null!==(n=t[e])&&void 0!==n&&n.length&&(a.options=t[e]),[e,a]})):{};return s(e)},g=({schema:e,data:n,renderContent:a,enableUrlSync:l=!0,className:i=""})=>{const[o,c]=r.useState({}),[h,g]=r.useState([]),[b,j]=r.useState(!0),[v,N]=r.useState(null);r.useEffect(()=>{(async()=>{j(!0),N(null);try{let e;if(Array.isArray(n))e=n;else if("string"==typeof n){const r=await fetch(n);if(!r.ok)throw new Error(`Failed to fetch: ${r.status} ${r.statusText}`);e=await r.json()}else"function"==typeof n?e=await n():(console.warn("DatasetFilter: data must be array, URL string, or async function"),e=[]);const r=Array.isArray(e)?e:[];g(r)}catch(e){console.error("DatasetFilter error:",e),N(e),g([])}finally{j(!1)}})()},[n]);const w=r.useCallback((e,r)=>{c(t=>{const s={...t};return null==r||""===r||Array.isArray(r)&&0===r.length||!1===r?delete s[e]:s[e]=r,s})},[]);r.useEffect(()=>{if(l)try{const e=new URLSearchParams(window.location.search).get("f");if(e){const r=(e=>{try{return JSON.parse(decodeURIComponent(atob(e)))}catch{return{}}})(e);Object.keys(r).length>0&&c(r)}}catch(e){console.error("Failed to decode filters from URL:",e)}},[l]),r.useEffect(()=>{if(l)try{const e=y(o);if(!e)return void window.history.replaceState({},"",window.location.pathname);const r=new URLSearchParams;r.set("f",e),window.history.replaceState({},"",`?${r.toString()}`)}catch(e){console.error("Failed to encode filters to URL:",e)}},[o,l]);const k=r.useMemo(()=>{const r=Array.isArray(h)?h:[];return p(e,r)},[e,h]),C=r.useMemo(()=>((e,r,t)=>{if(!Array.isArray(e))return[];if(!e.length)return[];if(!r||!Object.keys(r).length)return e;const{flat:s,search:n}=f(t);return e.filter(e=>{var t;if(n&&null!==(t=r[n.key])&&void 0!==t&&t.trim()){const t=r[n.key].toLowerCase();if(!(Array.isArray(n.config.fields)?n.config.fields:[n.config.field]).some(r=>{const s=m(e,r);return Array.isArray(s)?s.some(e=>String(e||"").toLowerCase().includes(t)):String(s||"").toLowerCase().includes(t)}))return!1}return Object.entries(r).every(([r,t])=>{if(n&&r===n.key)return!0;if(!t||Array.isArray(t)&&!t.length)return!0;const a=s[r];if(!a)return!0;let l=m(e,a.field);const i=x[a.type];return!i||i(l,t,a)})})})(Array.isArray(h)?h:[],o,k),[h,o,k]);return b?s.jsx("div",{className:"flex items-center justify-center min-h-screen",children:s.jsxs("div",{className:"text-center",children:[s.jsx(t.Loader2,{className:"w-8 h-8 animate-spin text-blue-600 mx-auto mb-2"}),s.jsx("p",{className:"text-gray-600",children:"Loading data..."})]})}):v?s.jsx("div",{className:"flex items-center justify-center min-h-screen",children:s.jsxs("div",{className:"text-center",children:[s.jsxs("div",{className:"text-red-600 mb-4",children:[s.jsx("p",{className:"font-semibold text-lg mb-2",children:"Error loading data"}),s.jsx("p",{className:"text-sm",children:v.message})]}),s.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors",children:"Retry"})]})}):s.jsxs("div",{className:`flex min-h-screen bg-gray-50 ${i}`,children:[s.jsx(d,{schema:k,filters:o,onFilterChange:w}),s.jsx("div",{className:"flex-1 p-8",children:s.jsxs("div",{className:"max-w-5xl mx-auto",children:[s.jsx(u,{schema:k,filters:o,onFilterChange:w,onRemoveFilter:w}),a&&a({filteredData:C,totalData:h,filters:o})]})})]})},b=new e.QueryClient;exports.DatasetFilter=r=>s.jsx(e.QueryClientProvider,{client:b,children:s.jsx(g,{...r})});
//# sourceMappingURL=index.js.map
