"use strict";var e=require("react"),r=require("@tanstack/react-query"),t=require("lucide-react"),s=require("react/jsx-runtime");const n=({label:r,isNested:n=!1,children:a,defaultExpanded:l=!0})=>{const[c,i]=e.useState(l),o=n?"h4":"h3",h=n?"text-xs font-medium text-gray-700 pb-2":"text-[13px] font-semibold text-gray-800 tracking-wide uppercase pb-2",d=n?"":" mb-3 border-b border-gray-200";return s.jsxs("div",{className:d,children:[s.jsxs("button",{onClick:()=>i(!c),className:"w-full flex justify-between group",children:[s.jsx(o,{className:h,children:r}),s.jsx(t.ChevronDown,{className:"w-5 h-5 text-gray-600 hover:text-primary-600 transition-transform "+(c?"rotate-180":"")})]}),c&&s.jsx("div",{className:"mb-3 space-y-0.5",children:a})]})},a=({checked:e,onChange:r,label:t})=>s.jsxs("label",{className:"flex items-start gap-3 cursor-pointer group w-fit",children:[s.jsx("input",{type:"checkbox",checked:e,onChange:r,className:"mt-0.5 w-4 h-4 rounded-sm border-gray-300 accent-primary-600 focus:ring-primary-500 cursor-pointer transition-colors group-hover:border-primary-600"}),s.jsx("span",{className:"text-sm text-gray-900 font-light group-hover:text-primary-600 transition-colors",children:t})]}),l=({config:r={},value:t=[],onChange:l,isNested:c=!1})=>{const[i,o]=e.useState(!1),h=e.useCallback(e=>{const r=t.includes(e)?t.filter(r=>r!==e):[...t,e];l(r.length?r:void 0)},[t,l]);if(!r.options||0===r.options.length)return null;const d=i?r.options:r.options.slice(0,5);return s.jsxs(n,{label:r.label,isNested:c,children:[d.map(e=>s.jsx(a,{label:e,checked:(null==t?void 0:t.includes(e))||!1,onChange:()=>h(e)},e)),r.options.length>5&&s.jsx("button",{onClick:()=>o(!i),className:"mt-2 text-primary-600 hover:text-primary-500 text-xs inline-flex items-center gap-1 underline",children:i?"See less":"See all"})]})},c=({config:r,value:t=[],onChange:l,isNested:c=!1})=>{var i;const o=e.useCallback(e=>{const r=t.includes(e)?t.filter(r=>r!==e):[...t,e];l(r.length?r:void 0)},[t,l]);return null!==(i=r.ranges)&&void 0!==i&&i.length?s.jsx(n,{label:r.label,isNested:c,children:r.ranges.map(e=>s.jsx(a,{label:e.label,checked:(null==t?void 0:t.includes(e.label))||!1,onChange:()=>o(e.label)},e.label))}):null},i=({config:e,value:r=!1,onChange:t})=>s.jsx("div",{children:s.jsx(a,{checked:!!r,onChange:e=>t(!!e.target.checked||void 0),label:e.label})}),o=({config:e,filters:r,onFilterChange:t,defaultExpanded:a=!0})=>e.children&&0!==e.children.length?s.jsx(n,{label:e.label,defaultExpanded:a,children:e.children.map(n=>{const a=e.childrenSchema[n];return a?"checkbox-group"===a.type?s.jsx(l,{config:a,value:r[n],onChange:e=>t(n,e),isNested:!0},n):"range"===a.type?s.jsx(c,{config:a,value:r[n],onChange:e=>t(n,e),isNested:!0},n):null:null})}):null,h=({schema:r,filters:n,onRemove:a})=>{const l=e.useMemo(()=>{const e=[],t=r=>{Object.entries(r).forEach(([r,s])=>{if("group"===s.type&&s.childrenSchema)return void t(s.childrenSchema);const a=n[r];a&&("search"===s.type?e.push({key:r,label:a,type:"search"}):"checkbox"===s.type&&!0===a?e.push({key:r,label:s.label,type:"checkbox"}):Array.isArray(a)&&a.length>0&&a.forEach(t=>e.push({key:r,label:t,type:"array",value:t})))})};return t(r),e},[r,n]);return l.length?s.jsx("div",{className:"flex flex-wrap gap-2 mt-3",children:l.map(e=>s.jsxs("span",{className:"inline-flex items-center gap-1.5 px-2 py-1 bg-primary-100/80 text-gray-700 text-sm border",children:[s.jsx("span",{children:e.label}),s.jsx("button",{onClick:()=>a(e),className:"hover:text-primary-600 rounded-full p-0.5 transition-colors",children:s.jsx(t.X,{className:"w-3.5 h-3.5"})})]},`${e.key}-${e.value||""}`))}):null},d=({schema:e,filters:r,onFilterChange:n})=>{const a=Object.entries(e).find(([e,r])=>"search"===r.type);if(!a)return null;const[l,c]=a,i=r[l]||"";return s.jsxs("div",{className:"mb-6",children:[s.jsxs("div",{className:"relative",children:[s.jsx(t.Search,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),s.jsx("input",{type:"text",placeholder:c.placeholder,value:i,onChange:e=>n(l,e.target.value),className:"w-full pl-10 pr-10 py-3 border border-gray-400/70 focus:ring-1 focus:ring-primary-500 focus:border-transparent outline-none text-sm"}),i&&s.jsx("button",{onClick:()=>n(l,""),className:"absolute right-3 top-1/2 -translate-y-1/2",children:s.jsx(t.X,{className:"w-4 h-4 text-gray-400 hover:text-gray-600"})})]}),s.jsx(h,{schema:e,filters:r,onRemove:e=>{if("search"===e.type)n(e.key,"");else if("array"===e.type){const t=(r[e.key]||[]).filter(r=>r!==e.value);n(e.key,t.length?t:void 0)}else"checkbox"===e.type&&n(e.key,void 0)}})]})},u=({schema:r,filters:n,onFilterChange:a})=>{const[h,d]=e.useState(!0),u=Object.entries(r).filter(([,e])=>"checkbox"===e.type);return s.jsxs("div",{className:"w-72 bg-white border-r border-gray-200 h-screen overflow-y-auto p-6 sticky top-0 custom-scroll",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-6",children:[s.jsx(t.SlidersHorizontal,{className:"w-5 h-5 text-primary-600"}),s.jsx("h2",{className:"text-lg font-semibold text-gray-900 tracking-tight",children:"Filters"})]}),u.length>0&&s.jsxs("div",{className:"pb-3 mb-3 border-b border-gray-200",children:[s.jsxs("button",{onClick:()=>d(!h),className:"w-full flex items-center justify-between group",children:[s.jsx("h3",{className:"text-[13px] font-semibold text-gray-800 tracking-wide uppercase",children:"General"}),s.jsx(t.ChevronDown,{className:"w-5 h-5 text-gray-600 hover:text-primary-600 transition-transform "+(h?"rotate-180":"")})]}),h&&s.jsx("div",{className:"space-y-0.5 mt-2",children:u.map(([e,r])=>s.jsx(i,{config:r,value:n[e],onChange:r=>a(e,r)},e))})]}),Object.entries(r).map(([e,r])=>((e,r)=>"search"===r.type?null:"group"===r.type?s.jsx(o,{config:r,filters:n,onFilterChange:a},e):"checkbox-group"===r.type?s.jsx(l,{config:r,value:n[e],onChange:r=>a(e,r)},e):"range"===r.type?s.jsx(c,{config:r,value:n[e],onChange:r=>a(e,r)},e):null)(e,r))]})},m=(e,r)=>r&&e?r.split(".").reduce((e,r)=>null==e?null:e[r],e):null,p=(e,r)=>{const t=((e,r)=>{const t={},s={};var n;return n=r,Object.entries(n).forEach(([e,r])=>{"group"===r.type&&r.childrenSchema?Object.entries(r.childrenSchema).forEach(([e,r])=>{s[e]=r}):s[e]=r}),Object.entries(s).forEach(([r,s])=>{if(s.options&&s.options.length>0)return;if(!["checkbox-group","select","checkbox"].includes(s.type))return;const n=new Set;e.forEach(e=>{let r=m(e,s.field);s.transform&&null!=r&&(r=s.transform(r)),s.isArray&&Array.isArray(r)?r.forEach(e=>null!==e&&n.add(String(e))):null!=r&&n.add(String(r))}),t[r]=Array.from(n).sort()}),t})(r,e),s={};return Object.entries(e).forEach(([e,r])=>{s[e]={...r},"group"===r.type&&r.childrenSchema?(s[e].childrenSchema={},Object.entries(r.childrenSchema).forEach(([r,n])=>{s[e].childrenSchema[r]={...n},t[r]&&t[r].length>0&&(s[e].childrenSchema[r].options=t[r])})):t[e]&&t[e].length>0&&(s[e].options=t[e])}),s},x=e=>{try{const r=(e=>{const r={};return Object.entries(e).forEach(([e,t])=>{null==t||""===t||Array.isArray(t)&&0===t.length||!1===t||(r[e]=t)}),r})(e);if(0===Object.keys(r).length)return"";const t=JSON.stringify(r);return btoa(encodeURIComponent(t))}catch(e){return""}};exports.DatasetFilter=({schema:n,data:a=[],queryKey:l,queryFn:c,dataTransform:i=e=>e,renderContent:o,enableUrlSync:h=!0,queryOptions:g={},className:y=""})=>{const[f,b]=e.useState({});let j=!0,v=null;try{v=r.useQueryClient()}catch(e){j=!1}const N=!!c&&j,w=r.useQuery({queryKey:l||["dataset"],queryFn:c,enabled:N,...g}),{data:C,isLoading:k,error:S}=N?w:{data:null,isLoading:!1,error:null},A=e.useMemo(()=>N&&C?i(C)||[]:a,[N,C,i,a]),E=e.useMemo(()=>p(n,A),[n,A]),O=e.useMemo(()=>((e,r,t)=>{const s={};var n;return n=t,Object.entries(n).forEach(([e,r])=>{"group"===r.type&&r.childrenSchema?Object.entries(r.childrenSchema).forEach(([e,r])=>{s[e]=r}):"search"!==r.type&&(s[e]=r)}),e.filter(e=>Object.entries(r).every(([r,t])=>{if(!t||Array.isArray(t)&&0===t.length)return!0;const n=s[r];if(!n)return!0;let a=m(e,n.field);switch(n.type){case"search":return(Array.isArray(n.fields)?n.fields:[n.field]).some(r=>{const s=m(e,r);return String(s||"").toLowerCase().includes(t.toLowerCase())});case"checkbox-group":{n.transform&&null!=a&&(a=n.transform(a));const e=Array.isArray(a)?a:[a],r=Array.isArray(t)?t:[t],s=e.map(e=>e?String(e).toLowerCase():e),l=r.map(e=>e?String(e).toLowerCase():e);if(l.includes("other")&&n.options){const e=n.options.map(e=>e.toLowerCase());if(s.some(r=>r&&!e.includes(r)))return!0}return l.some(e=>s.includes(e))}case"range":{const e=Number(a);return!isNaN(e)&&null!=a&&t.some(r=>{const t=n.ranges.find(e=>e.label===r);return!!t&&e>=t.min&&e<=t.max})}case"checkbox":return!t||!!a;case"select":{if(!a)return!1;const e=String(a).toLowerCase(),r=String(t).toLowerCase();return"other"===r&&n.options?!n.options.map(e=>e.toLowerCase()).includes(e):e===r}default:return!0}}))})(A,f,E),[A,f,E]),L=e.useCallback((e,r)=>{b(t=>{const s={...t};return null==r||""===r||Array.isArray(r)&&0===r.length||!1===r?delete s[e]:s[e]=r,s})},[]);return e.useEffect(()=>{if(!h)return;const e=new URLSearchParams(window.location.search).get("f");e&&b((e=>{try{const r=decodeURIComponent(atob(e));return JSON.parse(r)}catch(e){return{}}})(e))},[h]),e.useEffect(()=>{if(!h)return;const e=x(f);if(!e)return void window.history.replaceState({},"",window.location.pathname);const r=new URLSearchParams;r.set("f",e),window.history.replaceState({},"",`?${r.toString()}`)},[f,h]),k?s.jsx("div",{className:"flex items-center justify-center min-h-screen",children:s.jsxs("div",{className:"text-center",children:[s.jsx(t.Loader2,{className:"w-8 h-8 animate-spin text-primary-600 mx-auto mb-2"}),s.jsx("p",{className:"text-gray-600",children:"Loading data..."})]})}):S?s.jsx("div",{className:"flex items-center justify-center min-h-screen",children:s.jsxs("div",{className:"text-center text-red-600",children:[s.jsx("p",{className:"font-semibold mb-2",children:"Error loading data"}),s.jsx("p",{className:"text-sm",children:S.message})]})}):s.jsxs("div",{className:`flex min-h-screen bg-gray-50 ${y}`,children:[s.jsx(u,{schema:E,filters:f,onFilterChange:L}),s.jsx("div",{className:"flex-1 p-8",children:s.jsxs("div",{className:"max-w-5xl mx-auto",children:[s.jsx(d,{schema:E,filters:f,onFilterChange:L,onRemoveFilter:L}),o&&o({filteredData:O,totalData:A,filters:f})]})})]})};
//# sourceMappingURL=index.js.map
